<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Problem Solver ChatBot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb {
      background: rgba(100, 116, 139, 0.4);
      border-radius: 10px;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .pulse {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .loader {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #6366f1;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 to-white min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-2xl glass-card rounded-3xl p-6">
    <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-6">üß† Problem Solver ChatBot</h1>
    
    <div id="chatBox" class="h-[30rem] overflow-y-auto space-y-4 px-3 py-4 bg-white/70 rounded-xl border border-gray-300 shadow-inner text-base" aria-live="polite"></div>
    
    <div class="flex justify-end mt-2">
      <button id="readAloudBtn"
              class="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-4 py-2 rounded-xl text-sm font-medium border border-indigo-300 shadow"
              title="Read last bot message aloud"
              aria-label="Read last bot message aloud">
        üîà Read Aloud
      </button>
    </div>

    <form id="chatForm" class="flex mt-4 gap-2" autocomplete="off" role="search" aria-label="Chat input form">
      <label for="userInput" class="sr-only">Describe your problem</label>
      <input type="text" id="userInput" 
             class="flex-grow rounded-xl border border-gray-300 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white/80 backdrop-blur"
             placeholder="Describe your problem..." required aria-label="Describe your problem" />
      <button type="submit" id="sendBtn"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl text-base font-medium shadow transition duration-200"
              aria-label="Send message">
        Send
      </button>
      <button type="button" id="voiceBtn"
              class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 px-4 py-3 rounded-xl shadow pulse transition duration-200"
              title="Voice Input"
              aria-label="Voice input">
        üéôÔ∏è
      </button>
    </form>
    <div id="loader" class="hidden mt-4"><div class="loader"></div></div>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");
    const voiceBtn = document.getElementById("voiceBtn");
    const readAloudBtn = document.getElementById("readAloudBtn");
    const loader = document.getElementById("loader");
    const sendBtn = document.getElementById("sendBtn");

    const chatHistory = [
      {
        role: "system",
        content: `You are an intelligent, task-oriented AI assistant designed to solve problems, offer step-by-step reasoning, and guide users toward clear, practical solutions.`
      }
    ];

    function escapeHTML(text) {
      return text.replace(/[&<>"']/g, (char) =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[char])
      );
    }

    function addMessage(sender, message) {
      const msgDiv = document.createElement("div");
      const isBot = sender === "ChatBot";
      msgDiv.className = `max-w-[85%] px-4 py-3 rounded-2xl whitespace-pre-wrap ${
        isBot ? 'bg-indigo-100 self-start text-indigo-900' : 'bg-indigo-600 text-white self-end'
      } shadow-md transition-transform duration-300 ease-in-out`;
      msgDiv.innerHTML = `<strong>${escapeHTML(sender)}:</strong><br>${escapeHTML(message).replace(/\n/g, "<br>")}`;
      
      const container = document.createElement("div");
      container.className = `flex ${isBot ? 'justify-start' : 'justify-end'}`;
      container.appendChild(msgDiv);
      chatBox.appendChild(container);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showLoader(show) {
      loader.classList.toggle('hidden', !show);
    }

    function toggleSendButton(disable) {
      sendBtn.disabled = disable;
      sendBtn.classList.toggle('opacity-50', disable);
      sendBtn.classList.toggle('cursor-not-allowed', disable);
    }

    function speak(text) {
      const synth = window.speechSynthesis;
      const loadVoices = new Promise((resolve) => {
        let voices = synth.getVoices();
        if (voices.length) return resolve(voices);
        synth.onvoiceschanged = () => resolve(synth.getVoices());
      });
      loadVoices.then((voices) => {
        const robotVoice = voices.find(v =>
          /Fred|Zira|Google UK English Male|Microsoft David|en-US/i.test(v.name)
        ) || voices[0];
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = robotVoice;
        utterance.rate = 0.9;
        utterance.pitch = 0.4;
        utterance.volume = 1.0;
        synth.cancel();
        synth.speak(utterance);
      });
    }

    readAloudBtn.addEventListener("click", () => {
      const botMessages = [...chatBox.querySelectorAll("div.justify-start strong")];
      const lastMsg = botMessages.length > 0 ? botMessages[botMessages.length - 1].parentElement : null;
      if (lastMsg) {
        const text = lastMsg.innerText.replace(/^ChatBot:\s*/, "").trim();
        speak(text);
      }
    });

    voiceBtn.addEventListener("click", () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        addMessage("ChatBot", "‚ö†Ô∏è Voice recognition not supported in this browser. Try Chrome or Edge.");
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.continuous = false;
      addMessage("ChatBot", "üéôÔ∏è Listening... Please speak clearly.");
      recognition.start();
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        if (!transcript) {
          addMessage("ChatBot", "‚ö†Ô∏è No speech detected. Try again.");
          return;
        }
        userInput.value = transcript;
        chatForm.dispatchEvent(new Event('submit'));
      };
      recognition.onerror = (event) => {
        let errorMsg = "üé§ Voice error: ";
        if (event.error === "not-allowed") {
          errorMsg += "Microphone access was denied.";
        } else if (event.error === "no-speech") {
          errorMsg += "No speech detected. Try again.";
        } else {
          errorMsg += event.error;
        }
        addMessage("ChatBot", errorMsg);
      };
    });

    window.addEventListener("DOMContentLoaded", () => {
      const greeting = "üß† Hello. I am your problem-solving assistant. How may I assist you today?";
      addMessage("ChatBot", greeting);
      chatHistory.push({ role: "assistant", content: greeting });
    });

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = userInput.value.trim();
      if (!input) return;
      addMessage("You", input);
      userInput.value = "";
      chatHistory.push({ role: "user", content: input });
      showLoader(true);
      toggleSendButton(true);

      // üîπ General News detection
      if (/news/i.test(input)) {
        try {
          let typeMatch = input.match(/tesla|apple|business|techcrunch|wsj/i);
          let type = typeMatch ? typeMatch[0].toLowerCase() : 'general';

          const newsResponse = await fetch(`http://localhost:3000/api/news?type=${type}`);
          const newsData = await newsResponse.json();
          chatHistory.push({ role: "assistant", content: newsData.message });
          addMessage("ChatBot", newsData.message);
          showLoader(false);
          toggleSendButton(false);
          return;
        } catch (error) {
          console.error("News Error:", error);
          addMessage("ChatBot", "‚ö†Ô∏è Could not retrieve news.");
          showLoader(false);
          toggleSendButton(false);
          return;
        }
      }

      // üîπ Continue with command endpoint
      try {
        const commandResponse = await fetch("http://localhost:3000/api/command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: input })
        });
        const cmdResult = await commandResponse.json();
        if (!cmdResult.message.includes("Unknown")) {
          chatHistory.push({ role: "assistant", content: cmdResult.message });
          addMessage("ChatBot", cmdResult.message);
          showLoader(false);
          toggleSendButton(false);
          return;
        }
      } catch (error) {
        console.error("Command Error:", error);
      }

      // üîπ Fallback to AI chat
      try {
        const response = await fetch("http://localhost:3000/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: "deepseek/deepseek-r1:free", messages: chatHistory })
        });
        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "Sorry, I couldn't fetch a response.";
        chatHistory.push({ role: "assistant", content: reply });
        addMessage("ChatBot", reply);
      } catch (error) {
        console.error("Error:", error);
        addMessage("ChatBot", "‚ö†Ô∏è Something went wrong. Please check your server or connection. Try again later.");
      }

      showLoader(false);
      toggleSendButton(false);
    });

    userInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>
