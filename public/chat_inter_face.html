<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Problem Solver ChatBot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb {
      background: rgba(100, 116, 139, 0.4);
      border-radius: 10px;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 to-white min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-2xl glass-card rounded-3xl p-6">
    <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-6">üß† Problem Solver ChatBot</h1>
    
    <div id="chatBox" class="h-[30rem] overflow-y-auto space-y-4 px-3 py-4 bg-white/70 rounded-xl border border-gray-300 shadow-inner text-base"></div>
    
    <div class="flex justify-end mt-2">
      <button id="readAloudBtn"
              class="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-4 py-2 rounded-xl text-sm font-medium border border-indigo-300 shadow"
              title="Read last bot message aloud">
        üîà Read Aloud
      </button>
    </div>

    <form id="chatForm" class="flex mt-4 gap-2">
      <input type="text" id="userInput" 
             class="flex-grow rounded-xl border border-gray-300 px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white/80 backdrop-blur"
             placeholder="Describe your problem..." required />
      <button type="submit" 
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl text-base font-medium shadow transition duration-200">
        Send
      </button>
      <button type="button" id="voiceBtn"
              class="bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 px-4 py-3 rounded-xl shadow pulse transition duration-200"
              title="Voice Input">
        üéôÔ∏è
      </button>
    </form>
  </div>

  <script>
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");
    const voiceBtn = document.getElementById("voiceBtn");
    const readAloudBtn = document.getElementById("readAloudBtn");

    const chatHistory = [
      {
        role: "system",
        content: `You are an intelligent, task-oriented AI assistant designed to solve problems, offer step-by-step reasoning, and guide users toward clear, practical solutions.`
      }
    ];

    function addMessage(sender, message) {
      const msgDiv = document.createElement("div");
      const isBot = sender === "ChatBot";
      msgDiv.className = `max-w-[85%] px-4 py-3 rounded-2xl whitespace-pre-wrap ${
        isBot ? 'bg-indigo-100 self-start text-indigo-900' : 'bg-indigo-600 text-white self-end'
      } shadow-md transition-transform duration-300 ease-in-out`;
      msgDiv.innerHTML = `<strong>${sender}:</strong><br>${message.replace(/\n/g, "<br>")}`;
      
      const container = document.createElement("div");
      container.className = `flex ${isBot ? 'justify-start' : 'justify-end'}`;
      container.appendChild(msgDiv);
      chatBox.appendChild(container);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function speak(text) {
      const synth = window.speechSynthesis;

      const loadVoices = new Promise((resolve) => {
        let voices = synth.getVoices();
        if (voices.length) return resolve(voices);
        synth.onvoiceschanged = () => resolve(synth.getVoices());
      });

      loadVoices.then((voices) => {
        const robotVoice = voices.find(v =>
          /Fred|Zira|Google UK English Male|Microsoft David|en-US/i.test(v.name)
        ) || voices[0];

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = robotVoice;
        utterance.rate = 0.9;
        utterance.pitch = 0.4;
        utterance.volume = 1.0;

        synth.cancel();
        synth.speak(utterance);
      });
    }

    // üîà Manual voice output on user click
    readAloudBtn.addEventListener("click", () => {
      const botMessages = [...chatBox.querySelectorAll("div.justify-start strong")];
      const lastMsg = botMessages.length > 0 ? botMessages[botMessages.length - 1].parentElement : null;
      if (lastMsg) {
        const text = lastMsg.innerText.replace(/^ChatBot:\s*/, "").trim();
        speak(text);
      }
    });

    // üéôÔ∏è Voice Input
    voiceBtn.addEventListener("click", () => {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        addMessage("ChatBot", "‚ö†Ô∏è Voice recognition not supported in this browser. Try Chrome or Edge.");
        return;
      }

      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.continuous = false;

      addMessage("ChatBot", "üéôÔ∏è Listening... Please speak clearly.");

      recognition.start();

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        console.log("Voice input:", transcript);
        userInput.value = transcript;
        chatForm.dispatchEvent(new Event('submit'));
      };

      recognition.onerror = (event) => {
        console.error("Voice recognition error:", event.error);
        let errorMsg = "üé§ Voice error: ";
        if (event.error === "not-allowed") {
          errorMsg += "Microphone access was denied.";
        } else if (event.error === "no-speech") {
          errorMsg += "No speech detected. Try again.";
        } else {
          errorMsg += event.error;
        }
        addMessage("ChatBot", errorMsg);
      };

      recognition.onend = () => {
        console.log("Voice recognition ended.");
      };
    });

    window.addEventListener("DOMContentLoaded", () => {
      const greeting = "üß† Hello. I am your problem-solving assistant. How may I assist you today?";
      addMessage("ChatBot", greeting);
      chatHistory.push({ role: "assistant", content: greeting });
      // speak(greeting); // Disabled auto-voice
    });

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = userInput.value.trim();
      if (!input) return;

      addMessage("You", input);
      userInput.value = "";
      chatHistory.push({ role: "user", content: input });

      try {
        const commandResponse = await fetch("http://localhost:3000/api/command", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: input })
        });
        const cmdResult = await commandResponse.json();
        if (!cmdResult.message.includes("Unknown")) {
          chatHistory.push({ role: "assistant", content: cmdResult.message });
          addMessage("ChatBot", cmdResult.message);
          // speak(cmdResult.message); // Disabled auto-voice
          return;
        }
      } catch (error) {
        console.error("Command Error:", error);
      }

      try {
        const response = await fetch("http://localhost:3000/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: "deepseek/deepseek-r1:free", messages: chatHistory })
        });
        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "Sorry, I couldn't fetch a response.";
        chatHistory.push({ role: "assistant", content: reply });
        addMessage("ChatBot", reply);
        // speak(reply); // Disabled auto-voice
      } catch (error) {
        console.error("Error:", error);
        addMessage("ChatBot", "‚ö†Ô∏è Something went wrong. Please check your server or connection.");
      }
    });
  </script>
</body>
</html>
